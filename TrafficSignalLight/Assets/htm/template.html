<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Templates</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- jQuery + Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: #f7fbff;
        }

        .page-header {
            background: #9ed0a6;
            color: #103b40;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .card {
            border-radius: 14px;
        }

        .template-row {
            border-bottom: 1px dashed #9ed0a6;
        }

        .pattern-badge {
            font-weight: 600;
        }

        .time-input {
            max-width: 160px;
        }

        .icon-traffic {
            height: 28px;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>

<body class="container py-4">
    <div class="page-header mb-4 d-flex align-items-center justify-content-between">
        <h4 class="m-0">Traffic Sign – Templates</h4>
        <div class="d-flex gap-2">
            <button id="btnRefresh" class="btn btn-outline-dark btn-sm">Refresh</button>
        </div>
    </div>

    <div class="row g-3">
        <!-- Left: Template editor -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="card-title m-0">Template</h5>
                        <div class="d-flex align-items-center gap-2">
                            <label class="form-label m-0">Select</label>
                            <select id="ddlTemplates" class="form-select form-select-sm" style="min-width: 260px;">
                                <option value="0">- New Template -</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input id="txtTemplateName" type="text" class="form-control" placeholder="Descriptive name..." />
                    </div>

                    <div class="border rounded p-2">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="m-0">Template Patterns (Schedule)</h6>
                            <div class="d-flex align-items-center gap-2">
                                <select id="ddlPatterns" class="form-select form-select-sm">
                                    <option value="0">-- Select Pattern --</option>
                                </select>
                                <button id="btnAddPattern" class="btn btn-success btn-sm">Add to Template</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:36px;"></th>
                                        <th>Pattern</th>
                                        <th style="width:180px;">Start</th>
                                        <th style="width:180px;">Finish</th>
                                    </tr>
                                </thead>
                                <tbody id="tblTemplatePatterns">
                                    <!-- dynamic rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button id="btnDeleteTemplate" class="btn btn-danger">Delete</button>
                        <button id="btnSaveTemplate" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Hints / Preview -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">How it works</h5>
                    <ol class="mb-3">
                        <li>اختر Template أو أنشئ واحد جديد (اختَر “- New Template -”).</li>
                        <li>اكتب الاسم.</li>
                        <li>اختر Light Pattern من القائمة ثم اضغط “Add to Template”.</li>
                        <li>عدّل أوقات <code>Start</code> / <code>Finish</code> (تنسيق HH:mm).</li>
                        <li>احذف أي صف لا تريده (X). القائمة المرسلة هي <strong>النهائية</strong>؛ أي صف محذوف سيتم حذفه في السيرفر.</li>
                        <li>اضغط “Save”. يتم الإرسال كـ <strong>POST + JSON</strong> على <code>/TLC/api/Template/Set</code>.</li>
                    </ol>

                    <div class="alert alert-info">
                        السيرفر سيقوم بمصالحة العلاقات:
                        <ul class="mb-0">
                            <li>الموجود في DB وغير موجود في الطلب → يُحذف.</li>
                            <li>الموجود في الطلب وغير موجود في DB → يُضاف.</li>
                            <li>الموجود في الاثنين → تُحدث أوقاته.</li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            Endpoints المستخدمة:
                            <ul class="mb-0">
                                <li><code>GET /TLC/api/Template/list</code></li>
                                <li><code>GET /TLC/api/Pattern/list</code></li>
                                <li><code>GET /TLC/api/TemplatePattern/list</code></li>
                                <li><code>POST /TLC/api/Template/Set</code></li>
                            </ul>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =======================
        // State
        // =======================
        let templates = [];         // [{ID, Name}]
        let patterns = [];          // [{ID, Name, Red, Amber, Green, ...}]
        let templatePatterns = [];  // [{ID, TemplateID, PetternID, StartFrom, FinishBy}]

        let currentTemplateID = 0;

        // =======================
        // Boot
        // =======================
        $(document).ready(function () {
            hookUi();
            refreshAll();
        });

        function hookUi() {
            $('#btnRefresh').on('click', refreshAll);

            $('#ddlTemplates').on('change', function () {
                const id = parseInt($(this).val(), 10) || 0;
                currentTemplateID = id;
                drawTemplateFields();
                drawTemplateRows();
            });

            $('#btnAddPattern').on('click', onAddPatternRow);
            $('#btnSaveTemplate').on('click', onSaveTemplate);
            $('#btnDeleteTemplate').on('click', onDeleteTemplate);
        }

        function refreshAll() {
            // clear UI
            $('#ddlTemplates').empty().append('<option value="0">- New Template -</option>');
            $('#ddlPatterns').empty().append('<option value="0">-- Select Pattern --</option>');
            $('#tblTemplatePatterns').empty();
            $('#txtTemplateName').val('');
            currentTemplateID = 0;

            // load data
            listTemplates().then(() => {
                listPatterns().then(() => {
                    listTemplatePatterns();
                });
            });
        }

        // =======================
        // API calls
        // =======================
        function listTemplates() {
            return $.ajax({
                url: 'http://localhost/TLC/api/Template/list',
                type: 'GET',
                success: function (data) {
                    templates = data || [];
                    // Append unique list
                    for (const t of templates) {
                        $('#ddlTemplates').append(`<option value="${t.ID}">${escapeHtml(t.Name || '')}</option>`);
                    }
                    // Default selection: New
                    $('#ddlTemplates').val('0');
                    currentTemplateID = 0;
                },
                error: function (xhr) {
                    alert('Failed to load templates: ' + (xhr.responseText || xhr.statusText));
                }
            });
        }

        function listPatterns() {
            return $.ajax({
                url: 'http://localhost/TLC/api/Pattern/list',
                type: 'GET',
                success: function (data) {
                    patterns = data || [];
                    // add placeholder new pattern if needed (optional)
                    for (const p of patterns) {
                        $('#ddlPatterns').append(`<option value="${p.ID}">${escapeHtml(p.Name || '')}</option>`);
                    }
                    $('#ddlPatterns').val('0');
                },
                error: function (xhr) {
                    alert('Failed to load patterns: ' + (xhr.responseText || xhr.statusText));
                }
            });
        }

        function listTemplatePatterns() {
            return $.ajax({
                url: 'http://localhost/TLC/api/TemplatePattern/list',
                type: 'GET',
                success: function (data) {
                    templatePatterns = data || [];
                    drawTemplateFields();
                    drawTemplateRows();
                },
                error: function (xhr) {
                    alert('Failed to load template patterns: ' + (xhr.responseText || xhr.statusText));
                }
            });
        }

        function postTemplateJson(payload, onOk) {
            $.ajax({
                url: 'http://localhost/TLC/api/Template/Set',
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(payload),
                success: function (resp) {
                    // Support both string and JSON responses
                    if (typeof resp === 'string') {
                        if (resp.toUpperCase().includes('OK')) {
                            onOk && onOk();
                        } else {
                            alert(resp);
                        }
                    } else {
                        if (resp && (resp.message === 'Ok' || resp.message === 'Deleted')) {
                            onOk && onOk(resp);
                        } else {
                            alert('Server response error');
                        }
                    }
                },
                error: function (xhr) {
                    alert('Error: ' + (xhr.responseText || xhr.statusText));
                }
            });
        }

        // =======================
        // UI draw / helpers
        // =======================
        function drawTemplateFields() {
            const t = templates.find(x => x.ID === currentTemplateID);
            $('#txtTemplateName').val(t ? (t.Name || '') : '');
        }

        function drawTemplateRows() {
            const tbody = $('#tblTemplatePatterns');
            tbody.empty();

            // rows for current template only
            const rows = templatePatterns.filter(x => x.TemplateID == currentTemplateID);

            for (const row of rows) {
                const p = patterns.find(pp => pp.ID === row.PetternID);
                const pname = p ? p.Name : ('Pattern #' + row.PetternID);

                // API returns times sometimes as "HH:mm:ss" – convert to "HH:mm" for <input type="time">
                const from = (row.StartFrom || '00:00:00').substring(0, 5);
                const to = (row.FinishBy || '23:59:59').substring(0, 5);

                tbody.append(`
                  <tr class="template-row" data-pattern-id="${row.PetternID}">
                    <td>
                      <button type="button" class="btn btn-outline-danger btn-sm btnRemoveRow" title="Remove">X</button>
                    </td>
                    <td>
                      <img class="icon-traffic" src="../img/traffic-light-30625.png" alt="tl" />
                      <span class="pattern-badge">${escapeHtml(pname)}</span>
                    </td>
                    <td>
                      <input type="time" class="form-control form-control-sm time-input from-input" value="${from}" />
                    </td>
                    <td>
                      <input type="time" class="form-control form-control-sm time-input to-input" value="${to}" />
                    </td>
                  </tr>
                `);
            }

            // bind remove handlers
            $('.btnRemoveRow').off('click').on('click', function () {
                $(this).closest('tr').remove();
            });
        }

        function onAddPatternRow() {
            const pid = parseInt($('#ddlPatterns').val(), 10) || 0;
            if (pid <= 0) { alert('Select a valid pattern.'); return; }

            // prevent duplicates
            const exists = $('#tblTemplatePatterns tr').toArray().some(tr => parseInt($(tr).attr('data-pattern-id'), 10) === pid);
            if (exists) { alert('Pattern already added to this template.'); return; }

            const p = patterns.find(x => x.ID === pid);
            const pname = p ? p.Name : ('Pattern #' + pid);

            $('#tblTemplatePatterns').append(`
                <tr class="template-row" data-pattern-id="${pid}">
                  <td>
                    <button type="button" class="btn btn-outline-danger btn-sm btnRemoveRow" title="Remove">X</button>
                  </td>
                  <td>
                    <img class="icon-traffic" src="../img/traffic-light-30625.png" alt="tl" />
                    <span class="pattern-badge">${escapeHtml(pname)}</span>
                  </td>
                  <td>
                    <input type="time" class="form-control form-control-sm time-input from-input" value="12:00" />
                  </td>
                  <td>
                    <input type="time" class="form-control form-control-sm time-input to-input" value="23:59" />
                  </td>
                </tr>
              `);

            // bind remove for the newly added row
            $('#tblTemplatePatterns tr:last .btnRemoveRow').on('click', function () {
                $(this).closest('tr').remove();
            });
        }

        // =======================
        // Save / Delete
        // =======================
        function onSaveTemplate() {
            const name = ($('#txtTemplateName').val() || '').trim();
            if (!name) { alert('Name is required.'); return; }

            // collect rows from DOM (this is the FINAL list)
            const rows = $('#tblTemplatePatterns tr').toArray();
            const payloadPatterns = rows.map(tr => {
                const $tr = $(tr);
                const patternId = parseInt($tr.attr('data-pattern-id'), 10);

                let from = ($tr.find('.from-input').val() || '00:00');
                let to = ($tr.find('.to-input').val() || '23:59');

                // Convert "HH:mm" -> "HH:mm:ss"
                if (/^\d{2}:\d{2}$/.test(from)) from = from + ':00';
                if (/^\d{2}:\d{2}$/.test(to)) to = to + ':00';

                return {
                    LightPatternID: patternId,
                    StartFrom: from,
                    FinishBy: to
                };
            });

            const payload = {
                ID: currentTemplateID, // 0 = new
                Name: name,
                Patterns: payloadPatterns
            };

            postTemplateJson(payload, () => {
                alert('Saved successfully.');
                // reload everything to reflect DB state
                refreshAll();
            });
        }

        function onDeleteTemplate() {
            if (!currentTemplateID || currentTemplateID <= 0) {
                alert('Select an existing template to delete.');
                return;
            }
            if (!confirm('Delete this template (and its schedule)?')) return;

            // deletion by sending ID < 0
            const payload = { ID: -currentTemplateID, Name: $('#txtTemplateName').val() || '' };
            postTemplateJson(payload, () => {
                alert('Deleted successfully.');
                refreshAll();
            });
        }

        // =======================
        // Utils
        // =======================
        function escapeHtml(str) {
            return String(str).replace(/[&<>"'`=\/]/g, function (s) {
                return ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
                    "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
                })[s];
            });
        }
    </script>
</body>
</html>